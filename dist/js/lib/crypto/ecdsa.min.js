function integerToBytes(t,e){var r=t.toByteArrayUnsigned();if(e<r.length)r=r.slice(r.length-e);else for(;e>r.length;)r.unshift(0);return r}ECFieldElementFp.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},ECPointFp.prototype.getEncoded=function(t){var e=this.getX().toBigInteger(),r=this.getY().toBigInteger(),i=integerToBytes(e,32);return t?r.isEven()?i.unshift(2):i.unshift(3):(i.unshift(4),i=i.concat(integerToBytes(r,32))),i},ECPointFp.decodeFrom=function(t,e){var r=e.length-1,i=e.slice(1,1+r/2),n=e.slice(1+r/2,1+r);i.unshift(0),n.unshift(0);var o=new BigInteger(i),g=new BigInteger(n);return new ECPointFp(t,t.fromBigInteger(o),t.fromBigInteger(g))},ECPointFp.prototype.add2D=function(t){if(this.isInfinity())return t;if(t.isInfinity())return this;if(this.x.equals(t.x))return this.y.equals(t.y)?this.twice():this.curve.getInfinity();var e=t.x.subtract(this.x),r=t.y.subtract(this.y),i=r.divide(e),n=i.square().subtract(this.x).subtract(t.x),o=i.multiply(this.x.subtract(n)).subtract(this.y);return new ECPointFp(this.curve,n,o)},ECPointFp.prototype.twice2D=function(){if(this.isInfinity())return this;if(0===this.y.toBigInteger().signum())return this.curve.getInfinity();var t=this.curve.fromBigInteger(BigInteger.valueOf(2)),e=this.curve.fromBigInteger(BigInteger.valueOf(3)),r=this.x.square().multiply(e).add(this.curve.a).divide(this.y.multiply(t)),i=r.square().subtract(this.x.multiply(t)),n=r.multiply(this.x.subtract(i)).subtract(this.y);return new ECPointFp(this.curve,i,n)},ECPointFp.prototype.multiply2D=function(t){if(this.isInfinity())return this;if(0===t.signum())return this.curve.getInfinity();var e,r=t,i=r.multiply(new BigInteger("3")),n=this.negate(),o=this;for(e=i.bitLength()-2;e>0;--e){o=o.twice();var g=i.testBit(e),u=r.testBit(e);g!=u&&(o=o.add2D(g?this:n))}return o},ECPointFp.prototype.isOnCurve=function(){var t=this.getX().toBigInteger(),e=this.getY().toBigInteger(),r=this.curve.getA().toBigInteger(),i=this.curve.getB().toBigInteger(),n=this.curve.getQ(),o=e.multiply(e).mod(n),g=t.multiply(t).multiply(t).add(r.multiply(t)).add(i).mod(n);return o.equals(g)},ECPointFp.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},ECPointFp.prototype.validate=function(){var t=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var e=this.getX().toBigInteger(),r=this.getY().toBigInteger();if(e.compareTo(BigInteger.ONE)<0||e.compareTo(t.subtract(BigInteger.ONE))>0)throw new Error("x coordinate out of bounds");if(r.compareTo(BigInteger.ONE)<0||r.compareTo(t.subtract(BigInteger.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(t).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0},ECDSA=function(){function t(t,e,r,i){for(var n=Math.max(e.bitLength(),i.bitLength()),o=t.add2D(r),g=t.curve.getInfinity(),u=n-1;u>=0;--u)g=g.twice2D(),g.z=BigInteger.ONE,e.testBit(u)?g=i.testBit(u)?g.add2D(o):g.add2D(t):i.testBit(u)&&(g=g.add2D(r));return g}var e=getSECCurveByName("secp256k1"),r=new SecureRandom,i=null,n={getBigRandom:function(t){return new BigInteger(t.bitLength(),r).mod(t.subtract(BigInteger.ONE)).add(BigInteger.ONE)},sign:function(t,r){var i=r,o=e.getN(),g=BigInteger.fromByteArrayUnsigned(t);do var u=n.getBigRandom(o),a=e.getG(),s=a.multiply(u),f=s.getX().toBigInteger().mod(o);while(f.compareTo(BigInteger.ZERO)<=0);var c=u.modInverse(o).multiply(g.add(i.multiply(f))).mod(o);return n.serializeSig(f,c)},verify:function(t,r,i){var o,g;if(Util.isArray(r)){var u=n.parseSig(r);o=u.r,g=u.s}else{if("object"!=typeof r||!r.r||!r.s)throw"Invalid value for signature";o=r.r,g=r.s}var a;if(i instanceof ECPointFp)a=i;else{if(!Util.isArray(i))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=ECPointFp.decodeFrom(e.getCurve(),i)}var s=BigInteger.fromByteArrayUnsigned(t);return n.verifyRaw(s,o,g,a)},verifyRaw:function(t,r,i,n){var o=e.getN(),g=e.getG();if(r.compareTo(BigInteger.ONE)<0||r.compareTo(o)>=0)return!1;if(i.compareTo(BigInteger.ONE)<0||i.compareTo(o)>=0)return!1;var u=i.modInverse(o),a=t.multiply(u).mod(o),s=r.multiply(u).mod(o),f=g.multiply(a).add(n.multiply(s)),c=f.getX().toBigInteger().mod(o);return c.equals(r)},serializeSig:function(t,e){var r=t.toByteArraySigned(),i=e.toByteArraySigned(),n=[];return n.push(2),n.push(r.length),n=n.concat(r),n.push(2),n.push(i.length),n=n.concat(i),n.unshift(n.length),n.unshift(48),n},parseSig:function(t){var e;if(48!=t[0])throw new Error("Signature not a valid DERSequence");if(e=2,2!=t[e])throw new Error("First element in signature must be a DERInteger");var r=t.slice(e+2,e+2+t[e+1]);if(e+=2+t[e+1],2!=t[e])throw new Error("Second element in signature must be a DERInteger");var i=t.slice(e+2,e+2+t[e+1]);e+=2+t[e+1];var n=BigInteger.fromByteArrayUnsigned(r),o=BigInteger.fromByteArrayUnsigned(i);return{r:n,s:o}},parseSigCompact:function(t){if(65!==t.length)throw"Signature has the wrong length";var r=t[0]-27;if(0>r||r>7)throw"Invalid signature type";var i=e.getN(),n=BigInteger.fromByteArrayUnsigned(t.slice(1,33)).mod(i),o=BigInteger.fromByteArrayUnsigned(t.slice(33,65)).mod(i);return{r:n,s:o,i:r}},recoverPubKey:function(r,o,g,u){u=3&u;var a=1&u,s=u>>1,f=e.getN(),c=e.getG(),l=e.getCurve(),y=l.getQ(),h=l.getA().toBigInteger(),d=l.getB().toBigInteger();i||(i=y.add(BigInteger.ONE).divide(BigInteger.valueOf(4)));var v=s?r.add(f):r,m=v.multiply(v).multiply(v).add(h.multiply(v)).add(d).mod(y),p=m.modPow(i,y),B=(p.isEven()?!a:a)?p:y.subtract(p),I=new ECPointFp(l,l.fromBigInteger(v),l.fromBigInteger(B));I.validate();var E=BigInteger.fromByteArrayUnsigned(g),w=BigInteger.ZERO.subtract(E).mod(f),b=r.modInverse(f),C=t(I,o,c,w).multiply(b);if(C.validate(),!n.verifyRaw(E,r,o,C))throw"Pubkey recovery unsuccessful";var P=new ECKey;return P.pub=C,P},calcPubkeyRecoveryParam:function(t,e,r,i){for(var o=0;4>o;o++)try{var g=n.recoverPubKey(e,r,i,o);if(g.getBitcoinAddress().toString()==t)return o}catch(u){}throw"Unable to find valid recovery factor"}};return n}();