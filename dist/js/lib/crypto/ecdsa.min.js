function integerToBytes(i,len){var bytes=i.toByteArrayUnsigned();if(len<bytes.length)bytes=bytes.slice(bytes.length-len);else for(;len>bytes.length;)bytes.unshift(0);return bytes}ECFieldElementFp.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},ECPointFp.prototype.getEncoded=function(compressed){var x=this.getX().toBigInteger(),y=this.getY().toBigInteger(),enc=integerToBytes(x,32);return compressed?y.isEven()?enc.unshift(2):enc.unshift(3):(enc.unshift(4),enc=enc.concat(integerToBytes(y,32))),enc},ECPointFp.decodeFrom=function(curve,enc){var dataLen=enc.length-1,xBa=enc.slice(1,1+dataLen/2),yBa=enc.slice(1+dataLen/2,1+dataLen);xBa.unshift(0),yBa.unshift(0);var x=new BigInteger(xBa),y=new BigInteger(yBa);return new ECPointFp(curve,curve.fromBigInteger(x),curve.fromBigInteger(y))},ECPointFp.prototype.add2D=function(b){if(this.isInfinity())return b;if(b.isInfinity())return this;if(this.x.equals(b.x))return this.y.equals(b.y)?this.twice():this.curve.getInfinity();var x_x=b.x.subtract(this.x),y_y=b.y.subtract(this.y),gamma=y_y.divide(x_x),x3=gamma.square().subtract(this.x).subtract(b.x),y3=gamma.multiply(this.x.subtract(x3)).subtract(this.y);return new ECPointFp(this.curve,x3,y3)},ECPointFp.prototype.twice2D=function(){if(this.isInfinity())return this;if(0===this.y.toBigInteger().signum())return this.curve.getInfinity();var TWO=this.curve.fromBigInteger(BigInteger.valueOf(2)),THREE=this.curve.fromBigInteger(BigInteger.valueOf(3)),gamma=this.x.square().multiply(THREE).add(this.curve.a).divide(this.y.multiply(TWO)),x3=gamma.square().subtract(this.x.multiply(TWO)),y3=gamma.multiply(this.x.subtract(x3)).subtract(this.y);return new ECPointFp(this.curve,x3,y3)},ECPointFp.prototype.multiply2D=function(k){if(this.isInfinity())return this;if(0===k.signum())return this.curve.getInfinity();var i,e=k,h=e.multiply(new BigInteger("3")),neg=this.negate(),R=this;for(i=h.bitLength()-2;i>0;--i){R=R.twice();var hBit=h.testBit(i),eBit=e.testBit(i);hBit!=eBit&&(R=R.add2D(hBit?this:neg))}return R},ECPointFp.prototype.isOnCurve=function(){var x=this.getX().toBigInteger(),y=this.getY().toBigInteger(),a=this.curve.getA().toBigInteger(),b=this.curve.getB().toBigInteger(),n=this.curve.getQ(),lhs=y.multiply(y).mod(n),rhs=x.multiply(x).multiply(x).add(a.multiply(x)).add(b).mod(n);return lhs.equals(rhs)},ECPointFp.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},ECPointFp.prototype.validate=function(){var n=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var x=this.getX().toBigInteger(),y=this.getY().toBigInteger();if(x.compareTo(BigInteger.ONE)<0||x.compareTo(n.subtract(BigInteger.ONE))>0)throw new Error("x coordinate out of bounds");if(y.compareTo(BigInteger.ONE)<0||y.compareTo(n.subtract(BigInteger.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(n).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0},ECDSA=function(){function implShamirsTrick(P,k,Q,l){for(var m=Math.max(k.bitLength(),l.bitLength()),Z=P.add2D(Q),R=P.curve.getInfinity(),i=m-1;i>=0;--i)R=R.twice2D(),R.z=BigInteger.ONE,k.testBit(i)?R=l.testBit(i)?R.add2D(Z):R.add2D(P):l.testBit(i)&&(R=R.add2D(Q));return R}var ecparams=getSECCurveByName("secp256k1"),rng=new SecureRandom,P_OVER_FOUR=null,ECDSA={getBigRandom:function(limit){return new BigInteger(limit.bitLength(),rng).mod(limit.subtract(BigInteger.ONE)).add(BigInteger.ONE)},sign:function(hash,priv){var d=priv,n=ecparams.getN(),e=BigInteger.fromByteArrayUnsigned(hash);do var k=ECDSA.getBigRandom(n),G=ecparams.getG(),Q=G.multiply(k),r=Q.getX().toBigInteger().mod(n);while(r.compareTo(BigInteger.ZERO)<=0);var s=k.modInverse(n).multiply(e.add(d.multiply(r))).mod(n);return ECDSA.serializeSig(r,s)},verify:function(hash,sig,pubkey){var r,s;if(Util.isArray(sig)){var obj=ECDSA.parseSig(sig);r=obj.r,s=obj.s}else{if("object"!=typeof sig||!sig.r||!sig.s)throw"Invalid value for signature";r=sig.r,s=sig.s}var Q;if(pubkey instanceof ECPointFp)Q=pubkey;else{if(!Util.isArray(pubkey))throw"Invalid format for pubkey value, must be byte array or ECPointFp";Q=ECPointFp.decodeFrom(ecparams.getCurve(),pubkey)}var e=BigInteger.fromByteArrayUnsigned(hash);return ECDSA.verifyRaw(e,r,s,Q)},verifyRaw:function(e,r,s,Q){var n=ecparams.getN(),G=ecparams.getG();if(r.compareTo(BigInteger.ONE)<0||r.compareTo(n)>=0)return!1;if(s.compareTo(BigInteger.ONE)<0||s.compareTo(n)>=0)return!1;var c=s.modInverse(n),u1=e.multiply(c).mod(n),u2=r.multiply(c).mod(n),point=G.multiply(u1).add(Q.multiply(u2)),v=point.getX().toBigInteger().mod(n);return v.equals(r)},serializeSig:function(r,s){var rBa=r.toByteArraySigned(),sBa=s.toByteArraySigned(),sequence=[];return sequence.push(2),sequence.push(rBa.length),sequence=sequence.concat(rBa),sequence.push(2),sequence.push(sBa.length),sequence=sequence.concat(sBa),sequence.unshift(sequence.length),sequence.unshift(48),sequence},parseSig:function(sig){var cursor;if(48!=sig[0])throw new Error("Signature not a valid DERSequence");if(cursor=2,2!=sig[cursor])throw new Error("First element in signature must be a DERInteger");var rBa=sig.slice(cursor+2,cursor+2+sig[cursor+1]);if(cursor+=2+sig[cursor+1],2!=sig[cursor])throw new Error("Second element in signature must be a DERInteger");var sBa=sig.slice(cursor+2,cursor+2+sig[cursor+1]);cursor+=2+sig[cursor+1];var r=BigInteger.fromByteArrayUnsigned(rBa),s=BigInteger.fromByteArrayUnsigned(sBa);return{r:r,s:s}},parseSigCompact:function(sig){if(65!==sig.length)throw"Signature has the wrong length";var i=sig[0]-27;if(0>i||i>7)throw"Invalid signature type";var n=ecparams.getN(),r=BigInteger.fromByteArrayUnsigned(sig.slice(1,33)).mod(n),s=BigInteger.fromByteArrayUnsigned(sig.slice(33,65)).mod(n);return{r:r,s:s,i:i}},recoverPubKey:function(r,s,hash,i){i=3&i;var isYEven=1&i,isSecondKey=i>>1,n=ecparams.getN(),G=ecparams.getG(),curve=ecparams.getCurve(),p=curve.getQ(),a=curve.getA().toBigInteger(),b=curve.getB().toBigInteger();P_OVER_FOUR||(P_OVER_FOUR=p.add(BigInteger.ONE).divide(BigInteger.valueOf(4)));var x=isSecondKey?r.add(n):r,alpha=x.multiply(x).multiply(x).add(a.multiply(x)).add(b).mod(p),beta=alpha.modPow(P_OVER_FOUR,p),y=(beta.isEven()?!isYEven:isYEven)?beta:p.subtract(beta),R=new ECPointFp(curve,curve.fromBigInteger(x),curve.fromBigInteger(y));R.validate();var e=BigInteger.fromByteArrayUnsigned(hash),eNeg=BigInteger.ZERO.subtract(e).mod(n),rInv=r.modInverse(n),Q=implShamirsTrick(R,s,G,eNeg).multiply(rInv);if(Q.validate(),!ECDSA.verifyRaw(e,r,s,Q))throw"Pubkey recovery unsuccessful";var pubKey=new ECKey;return pubKey.pub=Q,pubKey},calcPubkeyRecoveryParam:function(address,r,s,hash){for(var i=0;4>i;i++)try{var pubkey=ECDSA.recoverPubKey(r,s,hash,i);if(pubkey.getBitcoinAddress().toString()==address)return i}catch(e){}throw"Unable to find valid recovery factor"}};return ECDSA}();